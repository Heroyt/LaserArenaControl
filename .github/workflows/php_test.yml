name: PHP Unit test

on:
    push:
        branches: [ master ]
    pull_request:
        branches: [ master ]

jobs:
    build:

        runs-on: ${{ matrix.operating-system }}

        strategy:
            matrix:
                operating-system: [ ubuntu-latest ]
                php-version: [ '8.1' ]
                dependencies: [ '' ]
                coverage-driver: [ xdebug ]

        steps:
            -   name: Shutdown Ubuntu MySQL (SUDO)
                run: sudo service mysql stop # Shutdown the Default MySQL, "sudo" is necessary, please not remove it

            -   name: Set up MySQL
                uses: mirromutth/mysql-action@v1.1
                with:
                    mysql database: 'lac'
                    mysql root password: 'root'
                    
            -   uses: actions/checkout@master
            
            -   name: submodules-init
                uses: snickerbockers/submodules-init@v4

            -   name: Validate composer.json and composer.lock
                run: composer validate --strict

            -   name: Cache Composer packages
                id: composer-cache
                uses: actions/cache@v2
                with:
                    path: vendor
                    key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
                    restore-keys: |
                        ${{ runner.os }}-php-

            -   name: Install dependencies
                run: composer install --prefer-dist --no-progress -v

            -   name: Create dummy config file
                uses: finnp/create-file-action@1.0.0
                env:
                    FILE_NAME: private/config.ini
                    FILE_BASE64: "OyBNYWluIGNvbmZpZ3VyYXRpb24gZmlsZSBmb3IgRFRQIGFwcAoKW0RhdGFiYXNlXQpIT1NUID0gImxvY2FsaG9zdCIKUE9SVCA9IDMzMDYKVVNFUiA9ICJyb290IgpQQVNTID0gInJvb3QiCkRBVEFCQVNFID0gImxhYyIKQ09MTEFURSA9ICJ1dGY4bWI0IgpEUklWRVIgPSAibXlzcWxpIgpQUkVGSVggPSAiIgoKW0dlbmVyYWxdCkRFQlVHID0gdHJ1ZQpQUkVUVFlfVVJMID0gdHJ1ZQpDQUNIRV9WRVJTSU9OID0gMQpUSU1FWk9ORSA9ICJFdXJvcGUvUHJhZ3VlIgpUUkFOU0xBVElPTlMgPSB0cnVl"
            
            -   name: Wait for MySQL
                run: |
                    while ! mysqladmin ping --host=127.0.0.1 --password=$MYSQL_ROOT_PASSWORD --silent; do
                        sleep 1
                    done


            -   name: Run test suite
                env:
                    XDEBUG_MODE: coverage
                run: composer run testUnit
