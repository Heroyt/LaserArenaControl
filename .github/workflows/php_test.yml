name: PHP Unit test

on:
    push:
        branches: [ master ]
    pull_request:
        branches: [ master ]

jobs:
    build:

        runs-on: ${{ matrix.operating-system }}

        strategy:
            matrix:
                operating-system: [ ubuntu-latest ]
                php-version: [ '8.1' ]
                dependencies: [ '' ]
                coverage-driver: [ xdebug ]

        steps:
            -   name: Shutdown Ubuntu MySQL (SUDO)
                run: sudo service mysql stop # Shutdown the Default MySQL, "sudo" is necessary, please not remove it

            -   name: Set up MySQL
                uses: getong/mariadb-action@v1.1
                with:
                    host port: 3307
                    mysql database: 'lac'
                    mysql root password: 'root'

            -   uses: actions/checkout@master

            -   name: submodules-init
                uses: snickerbockers/submodules-init@v4

            -   name: Validate composer.json and composer.lock
                run: composer validate --strict

            -   name: Cache Composer packages
                id: composer-cache
                uses: actions/cache@v2
                with:
                    path: vendor
                    key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
                    restore-keys: |
                        ${{ runner.os }}-php-

            -   name: Install dependencies
                run: composer install --prefer-dist --no-progress -v

            -   name: Wait for MySQL
                run: |
                    while ! mysqladmin ping --host=127.0.0.1 --port=3307 --user=root --password=root --silent; do
                        sleep 1
                    done


            -   name: Run test suite
                env:
                    XDEBUG_MODE: coverage
                run: composer run test
